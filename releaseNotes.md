

# 本版本修改功能 20200613
- 适配新老数据库结构. 
  - `Action`中增加了`Path`字段, 老数据库中没有. 软件灵活适配
  - `catalog`中增加了`family`字段, 老数据库版本中没有, 灵活适配
  - 适配新老数据库中骨髓Image的路径定义协议
- 支持巨核细胞（Megakaryocyte), 包括显示, 轮廓, 分类等. 
- 解决了明显的内存泄漏问题.
- 解决了切换视图时预览图导致软件崩溃的问题
  晓斌代码中`clear()`之后再`removeItem()`使用不正确. 没有找到很好的删除方法, 最终改为重用方式, 避免释放内存. 
- 解决了保存结果到服务器上概率性崩溃的问题
  (晓斌代码中迭代器的使用不正确, `erase()`一个迭代器后, 迭代器指向的是下一个位置而不是被删除的item的位置. )
- 增加状态栏上显示玻片, 视图, 细胞等信息. 
- 新增的细胞类型在细胞视图中会立即显示
- 修改了更改细胞类型后细胞视图中的类别名称不能正确显示的问题
- 在视野视图中对细胞的删除，更改分类等操作会立即反馈到左边的分类视图中
- 改正了更改细胞类型、删除细胞后比例错误的缺陷
- 支持外周血和巨核细胞的预览图显示
- 其他内部重构： 
  - 修改`TaskListModel`和`UnassignedTaskListModel`的`_fetchOnce()`中如果提前退出, 会不停被重新调用的问题.
  - 代码重构，考虑模型类中数据库读取错误的更好的处理方式，考虑引入异常机制，给用户表现是因为没有数据还是读写错误的原因。现在的接口太复杂，状态传递太复杂。
  - 代码重构， `TiledView`和`GalleryView`合并, 简化代码实现. 
  - 代码重构, 合并外周血和骨髓血的细胞的显示Item. 使用统一
  - 其他代码优化和调整



# 未来版本计划

- 【**】增加从`ToolKit`中点击鼠标到`TiledView`之间的跳转功能
- 【**】 增加**本地Cache机制**。
- 【*】代码重构，`UnassignedTaskListModel`和`TaskListModel`应该合并成一个模型类
- 【\*】增加图像加密功能*形态中，骨髓的加密价值不大，外周血也不是很有意义，不像核型*
- 【*】和`DeepKaryo V2`合并

# 历史版本主要变更
- 临时规避`TaskListModel`和`UnassignedTaskListModel`的`_fetchOnce()`中如果提前退出, 会不停被重新调用的问题, 原因未知. 临时改为始终走下去来解决. 
- 修改程序布局，改为默认显示大图视图，并且和分类视图使用2:1的比例，窗口主体显示大图而不是细胞分类。
- 重构：引入`DeeoKaryo`新版本中的`BatchModel`作为`TaskListModel`和`UnassignedTaskListModel`的基类
- 重构：修改`DeepLabel`中的数据库读取接口，和`DeepKaryo V2`保持一致。
- 修改细胞在大图中的显示，从画轮廓图改为画框图并画出类别简写。
- 支持是否画细胞标记的控制，增加一个工具类控制按钮P
- 修改数据库读取机制，解决了大量玻片时列表中重复出现玻片的问题。从用户滚动触发`fetchMore()`改为定时触发`fetchOnce()`。
- 解决了双击`CatalogView`中的细胞，在预览图中位置红框不同步移动的缺陷
- 修改了`DeepLabel`中保存，提交，获取细胞时将`level`固定为2的缺陷。
- 代码优化和重构：
    - 增加一个定义的进度对话框类，避免每次的重复定制配置
    - 将获取细胞分类`getTypes()`改为`getTypesEx()`，支持英文类型名，英文简写
    - 将获取细胞分类从单独的操作改为`getTaskResult()`之中，从而不仅仅


是给细胞分类视图使用，也供其他的地方使用。
    - 将`TaskItem`改名为`SlideItem`，避免之前多次出现的混乱
- 解决预览图显示不正常的问题
- 增加`提交`（`Commit`）功能
- 缺陷：getTaskResult()中的参数使用错误，应该是任务ID，结果使用了玻片ID。
- 优化`报告`功能，处理服务器生成报告错误时的适应性
- 修改`TaskListModel`的分帧机制，从用户滚动触发`fetchMore()`改为定时触发，解决`QTableView`对`fetchMore`的支持存在缺陷的固有问题。
- 增加`报告`功能
- 重构了`TaskProxyModel`的实现
- 增加玻片合法性判断：双击玻片的时候检查玻片类别，只支持打开骨髓和外周血，禁止了核型，十倍等不支持的类别
- 增加了玻片列表的排序功能。
- 在Proxy的基础上重构了过滤机制，规避Server不支持复杂参数过滤的问题，支持查询所有`形态`类别
- 增加`QSortFilterProxyModel`的使用，增加缓存进制，彻底解决崩溃问题
- 解决重复在`已完成`，`未完成`，`待领取`的任务间切换时崩溃的问题
- 增加了根据`AssayType`和`CaseNumber`的搜索功能